# 5. 三维资源库设计（数据层/索引层/服务层/展示层）

## 5.0 分层结构图（Mermaid）
```mermaid
flowchart TB
  subgraph dataLayer[数据层]
    Meta[元数据<br/>3D几何 / 材质 / 动画 / 场景]
    Data[三维模型数据<br/>Source / Delivery]
    Store[存储<br/>多文件关联 / 打包存储]
  end
  subgraph indexLayer[索引层]
    ES[Elasticsearch<br/>元数据搜索]
    GeoSearch[几何特征检索<br/>(规划中)]
  end
  subgraph serviceLayer[服务层]
    Pipeline[处理管线<br/>转换 / 优化 / 压缩]
    Tools[工具集<br/>Blender / gltf-pipeline / obj2gltf]
  end
  subgraph uiLayer[展示层]
    Viewer[Web查看器<br/>Three.js / Babylon.js / model-viewer]
    Features[交互功能<br/>轨道 / 光照 / 标注 / AR]
  end

  Meta --> ES
  Data --> Pipeline
  Store --> ES
  Store --> Pipeline
  ES --> Viewer
  GeoSearch --> Viewer
  Pipeline --> Viewer
  Tools --> Pipeline
```

## 5.1 数据层：三维模型元数据
### 5.1.1 通用元数据
*参考影像资源库通用字段，包括项目信息、作者、版权、时间等。*

### 5.1.2 三维专用元数据
| 字段名称 | 说明 | 示例 |
|---|---|---|
| 面数 (Polygon Count) | 模型的多边形数量 | 150,000 |
| 顶点数 (Vertices) | 模型的顶点数量 | 75,000 |
| 纹理分辨率 (Texture Resolution) | 贴图的尺寸 | 4096 x 4096 |
| 材质 (Materials) | 包含的材质类型 | PBR, Phong |
| 骨骼绑定 (Rigging) | 是否包含骨骼绑定信息 | 是/否 |
| 动画 (Animation) | 是否包含动画片段 | 行走, 奔跑 |
| 场景层级 (Hierarchy) | 节点层级结构深度 | 5 |

## 5.2 数据层：格式与存储
### 5.2.1 格式分类
*   **源/保存格式 (Source/Preservation)**: 用于长期归档和再次编辑的高精度格式。
    *   **OBJ**: 通用交换格式，需配合 MTL 和贴图文件。
    *   **FBX**: 包含动画和骨骼信息的专有格式。
    *   **PLY**: 扫描数据常用格式，包含顶点颜色。
    *   **STL**: 3D 打印常用格式，仅包含几何体。
*   **交付/展示格式 (Delivery)**: 用于 Web 端和移动端的高效传输与渲染。
    *   **glTF / GLB**: "3D 领域的 JPEG"，支持 Draco 压缩，Web 友好。
    *   **USDZ**: Apple 生态系统首选，用于 AR 预览。

### 5.2.2 存储策略
*   **多文件资产管理**: 针对 OBJ 等格式，需将模型文件 (.obj)、材质文件 (.mtl) 和纹理图片 (.jpg/.png) 作为一个整体资产（Asset）进行关联存储，确保相对路径正确。
*   **打包存储**: 对于复杂的源文件项目，支持以 ZIP 包形式归档。
*   **版本管理**: 记录从源文件到交付文件的转换关系和版本历史。

## 5.3 索引层
*   **元数据检索**: 使用 **Elasticsearch** 对上述通用及三维专用元数据进行索引，支持范围查询（如面数筛选）和关键词查询。
*   **几何特征检索 (未来规划)**: 探索基于 3D 形状描述符（Shape Descriptors）或几何哈希（Geometric Hashing）的检索技术，实现“以形搜形”。

## 5.4 服务层：处理管线与工具
### 5.4.1 自动化处理管线
1.  **格式转换 (Format Conversion)**:
    *   将源格式 (OBJ, FBX, PLY) 转换为交付格式 (glTF/GLB, USDZ)。
    *   工具：`obj2gltf`, `Blender` CLI。
2.  **网格优化 (Mesh Optimization)**:
    *   **减面 (Decimation)**: 减少多边形数量以适应 Web 渲染。
    *   **LOD (Level of Detail)**: 生成不同精度的模型层级，根据视距自动切换。
    *   工具：`gltf-pipeline`, `MeshOptimizer`.
3.  **纹理与几何压缩**:
    *   **Draco**: 对几何体（顶点、索引）进行高比率压缩。
    *   **KTX2 / Basisu**: 对纹理进行 GPU 友好的压缩。
    *   工具：`gltf-pipeline`.

### 5.4.2 核心工具集
*   **glTF-Pipeline**: 用于 glTF/GLB 的优化、压缩和转换。
*   **Blender**: 强大的开源 3D 套件，用于复杂的格式转换和预处理脚本。
*   **obj2gltf**: 专门用于 OBJ 转 glTF 的工具。

## 5.5 展示层：Web 查看器与交互
### 5.5.1 Web 查看器技术选型
*   **Three.js**: 底层 3D 引擎，灵活性最高，适合定制化开发。
*   **Babylon.js**: 功能强大的 3D 引擎，提供完整的游戏级特性。
*   **<model-viewer>**: Google 推出的 Web Component，集成简单，原生支持 AR，适合快速展示。

### 5.5.2 核心功能
*   **交互控制**: 轨道控制器 (Orbit Controls)，支持旋转、缩放、平移。
*   **光照与环境**: 支持 IBL (基于图像的照明) 和动态光源调节，还原真实质感。
*   **标注 (Annotations)**: 支持在模型表面添加热点标注，点击展示详细信息。
*   **AR 模式 (WebXR)**: 移动端支持一键进入 AR 模式，将模型放置在现实场景中 (通过 ARCore/ARKit)。
